@page
@model Iteracion_2.Pages.Analitica.ReporteModel
@{
    ViewData["Title"] = "Reporte";
}

<head>
    <link rel="stylesheet" href="~/css/border-radius.css" />
</head>

<body>
    <h1 style="text-align:center"><b>Reporte Configurable</b></h1>

    <div class="row">
        <select style="font-size:20px" id="configuracion">
            <option value="default">===Selecciona===</option>
            <option value="pais">País</option>
            <option value="tipo">Tipo de miembro</option>
            <option value="habilidades">Habilidades</option>
            <option value="hobbies">Hobbies</option>
            <option value="idiomas">Idioma</option>
        </select>

        <select style="font-size:20px" id="rellenarInfo" hidden></select>

        <input style="font-size:18px" id="realizarBusqueda" type="button" value="Graficar" disabled />
    </div>
    <br />
    <div class="row">
        <input id="datos" type="text" value="" placeholder="Filtros" disabled />
    </div>

    <div id="chart" class="col-lg-offset-2"></div>

    @section Scripts
        {
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

        <script type="text/javascript">
            google.charts.load('current', { 'packages': ['corechart'] });
            google.charts.setOnLoadCallback(drawChart);
            var $selecciones = "";
            var $cantidadSelecciones = []
            var $contador = 0;
            function drawChart() {
                var jsonData = $.ajax({
                    url: "/Analitica/Reporte?handler=ChartData",
                    dataType: "json",
                    async: false
                }).responseText;
                var data = new google.visualization.DataTable(jsonData);
                var options = {
                    'title': 'Miembros de la comunidad',
                    'width': 850,
                    'height': 650,
                };
                var chart = new google.visualization.PieChart(document.getElementById('chart'));
                chart.draw(data, options);
            }

            var $lista = []
            var $filtros = ""

            $("#configuracion").on('change', function (e) {
                $("#realizarBusqueda").prop("disabled", false);
                
                var valueSelected = this.value;
                var opciones;

                console.log("Length lista ",$lista.length)
                if ($lista.length < 2) {
                    $filtros += valueSelected + ","
                    $lista.push(valueSelected)
                    $("#datos").val($filtros)

                    if ($lista.length === 2) {
                        $('#rellenarInfo').show();
                        var jsonData = $.ajax({
                            url: "/Analitica/Reporte?handler=Opciones&Seleccion=" + $lista[1],
                            dataType: "string",
                            async: false
                        }).responseText;

                        jsonData = jsonData.substring(0, jsonData.length - 1)
                        opciones = jsonData.split(',')
                        for (var i = 0; i < opciones.length; i++) {
                            var o = new Option(opciones[i], "value");
                            $(o).html(opciones[i]);
                            $("#rellenarInfo").append(o);
                        }
                    }
                } else {
                    $("#rellenarInfo").empty();
                    $("#datos").val("")
                    $lista = []
                    $filtros = valueSelected + ","
                    $("#datos").val($filtros)
                    $lista.push(valueSelected)
                }
            });

            $('#realizarBusqueda').click(function () {
                var valueSelected = $('#rellenarInfo option:selected').html()

                if (valueSelected != null) {
                    $filtros += valueSelected
                }

                if ($filtros != "") {
                    var jsonData = $.ajax({
                        url: "/Analitica/Reporte?handler=ChartData&entrada=" + $filtros,
                        dataType: "json",
                        async: false
                    }).responseText;
                    var data = new google.visualization.DataTable(jsonData);
                    var options = {
                        'title': 'Miembros de la comunidad por: ' + $filtros,
                        'width': 850,
                        'height': 650
                    };

                    if ($lista.length === 1) {
                        var chart = new google.visualization.PieChart(document.getElementById('chart'));
                        console.log($lista)
                        chart.draw(data, options);
                    } else {
                        var chart = new google.visualization.BarChart(document.getElementById('chart'));
                        console.log($lista)
                        chart.draw(data, options);
                    }

                    $('#rellenarInfo').hide();
                    $("#realizarBusqueda").prop("disabled", true);
                    $("#rellenarInfo").empty();
                    $("#datos").val("")
                    $lista = []
                    $filtros = ""
                    $("#configuracion").val("default")
                } else {
                    drawChart();
                }
            });
        </script>
    }
</body>


